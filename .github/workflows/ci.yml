name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Verilator dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git help2man perl python3 make autoconf g++ flex bison ccache libfl2 libfl-dev zlib1g zlib1g-dev

      - name: Cache Verilator build
        id: cache-verilator
        uses: actions/cache@v4
        with:
          path: ~/verilator-install
          key: verilator-v5.040-${{ runner.os }}

      - name: Build and install Verilator v5.040
        if: steps.cache-verilator.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/verilator/verilator.git verilator-src
          cd verilator-src
          git checkout v5.040
          autoconf
          ./configure --prefix=$HOME/verilator-install
          make -j $(nproc)
          make install

      - name: Add Verilator to PATH
        run: echo "$HOME/verilator-install/bin" >> $GITHUB_PATH

      - name: Show Verilator version
        run: verilator --version

      - name: Compile Register File
        run: |
          verilator --binary --timing -j 0 \
            --top-module register_file_tb \
            rtl/register_file.sv tb/unit/register_file_tb.sv

      - name: Run Register File Tests
        run: ./obj_dir/Vregister_file_tb

      - name: Compile ALU
        run: |
          verilator --binary --timing -j 0 \
            --top-module Alu_tb \
            rtl/pkgs/alu_pkg.sv rtl/alu.sv tb/unit/alu_tb.sv

      - name: Run ALU Tests
        run: ./obj_dir/VAlu_tb

      - name: Compile xPSR
        run: |
          verilator --binary --timing -j 0 \
            --top-module xpsr_tb \
            rtl/pkgs/alu_pkg.sv rtl/xpsr.sv tb/unit/xpsr_tb.sv

      - name: Run ALU Tests
        run: ./obj_dir/Vxpsr_tb
